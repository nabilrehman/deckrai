<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reference Image Quality Test Suite</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1400px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #1a73e8;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    h2 {
      color: #185abc;
      margin-top: 30px;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #185abc;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #34a853;
    }
    button.secondary:hover {
      background: #2d8e47;
    }
    .file-input-wrapper {
      display: inline-block;
      position: relative;
      overflow: hidden;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    .file-input-wrapper label {
      background: #fbbc04;
      color: #333;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-block;
      transition: background 0.2s;
    }
    .file-input-wrapper label:hover {
      background: #f9ab00;
    }
    .output {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      max-height: 600px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success { color: #34a853; font-weight: bold; }
    .error { color: #ea4335; font-weight: bold; }
    .info { color: #4285f4; }
    .warning { color: #fbbc04; }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .image-preview {
      max-width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .image-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .image-card h4 {
      margin: 0 0 10px 0;
      color: #185abc;
    }
    .metrics {
      background: #e8f0fe;
      border-left: 4px solid #1a73e8;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .metrics h3 {
      margin: 0 0 10px 0;
      color: #1a73e8;
    }
    .metric-row {
      display: grid;
      grid-template-columns: 200px 1fr;
      padding: 5px 0;
      border-bottom: 1px solid #d2e3fc;
    }
    .metric-row:last-child {
      border-bottom: none;
    }
    .metric-label {
      font-weight: 600;
      color: #185abc;
    }
    .reference-upload {
      border: 2px dashed #1a73e8;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #e8f0fe;
      margin: 15px 0;
    }
    .reference-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 10px auto;
      display: block;
      border: 2px solid #1a73e8;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üß™ Reference Image Quality Test Suite</h1>

  <div class="test-section" style="background: #fff3cd; border-left: 4px solid #fbbc04;">
    <h2 style="color: #856404;">‚ÑπÔ∏è About 503 Errors</h2>
    <p style="color: #856404; margin: 0;">
      If you see a <strong>503 "The model is overloaded"</strong> error, this is a temporary issue with Google's Gemini API servers being busy.
      Simply <strong>wait 10-30 seconds and click the generate button again</strong>. The error is not related to our code or your reference images.
    </p>
  </div>

  <div class="test-section">
    <h2>Upload Reference Image</h2>
    <div class="reference-upload">
      <p>Upload a reference image to test style matching:</p>
      <div class="file-input-wrapper">
        <input type="file" id="reference-image-input" accept="image/*" onchange="handleReferenceUpload(event)">
        <label for="reference-image-input">üìÅ Choose Reference Image</label>
      </div>
      <div id="reference-preview-container" style="display:none; margin-top: 15px;">
        <p class="success">‚úÖ Reference image loaded!</p>
        <img id="reference-preview" class="reference-preview" alt="Reference preview">
        <p id="reference-info" style="font-size: 12px; color: #666;"></p>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>Test 1: Visual Slide with Reference Image</h2>
    <p>Generate a 16:9 visual slide using the uploaded reference image as a style guide.</p>
    <input type="text" id="test1-prompt" placeholder="Enter topic (e.g., AI in Healthcare: Transforming Patient Care)"
           value="AI in Healthcare: Transforming Patient Care"
           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
    <div class="controls">
      <button id="test1-btn" onclick="runTest1()" disabled>Generate Visual Slide WITH Reference</button>
      <button onclick="downloadImage('test1')" disabled id="download-test1">üíæ Download Image</button>
    </div>
    <div id="test1-output" class="output" style="display:none;"></div>
    <div id="test1-image-container"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Visual Slide WITHOUT Reference (Control)</h2>
    <p>Generate the same visual slide WITHOUT a reference image for comparison.</p>
    <input type="text" id="test2-prompt" placeholder="Enter topic (should match Test 1 for comparison)"
           value="AI in Healthcare: Transforming Patient Care"
           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
    <div class="controls">
      <button onclick="runTest2()">Generate Visual Slide WITHOUT Reference</button>
      <button onclick="downloadImage('test2')" disabled id="download-test2">üíæ Download Image</button>
    </div>
    <div id="test2-output" class="output" style="display:none;"></div>
    <div id="test2-image-container"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: LinkedIn Carousel with Reference</h2>
    <p>Generate a 4:5 LinkedIn carousel (5 slides) using the reference image.</p>
    <input type="text" id="test3-prompt" placeholder="Enter topic (e.g., Top 5 Productivity Tips for Remote Workers)"
           value="Top 5 Productivity Tips for Remote Workers"
           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
    <div class="controls">
      <button id="test3-btn" onclick="runTest3()" disabled>Generate Carousel WITH Reference</button>
    </div>
    <div id="test3-output" class="output" style="display:none;"></div>
    <div id="test3-image-container" class="image-grid"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Side-by-Side Comparison</h2>
    <p>Visual comparison of WITH vs WITHOUT reference image.</p>
    <button onclick="showComparison()">üìä Show Side-by-Side Comparison</button>
    <div id="comparison-container" class="image-grid" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>Quality Metrics</h2>
    <div id="metrics-container">
      <p class="info">Run tests to see quality metrics...</p>
    </div>
  </div>

  <script type="module">
    import { generateOnePager } from './services/onePagerService.js';

    window.generateOnePager = generateOnePager;

    // Global variables
    let referenceImageBase64 = null;
    let test1Result = null;
    let test2Result = null;
    let test3Result = null;

    // Handle reference image upload
    window.handleReferenceUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        referenceImageBase64 = e.target.result;

        document.getElementById('reference-preview').src = referenceImageBase64;
        document.getElementById('reference-preview-container').style.display = 'block';
        document.getElementById('reference-info').textContent =
          `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;

        // Enable test buttons
        document.getElementById('test1-btn').disabled = false;
        document.getElementById('test3-btn').disabled = false;
      };
      reader.readAsDataURL(file);
    };

    // Test 1: Visual Slide WITH Reference
    window.runTest1 = async () => {
      const btn = document.getElementById('test1-btn');
      const output = document.getElementById('test1-output');
      const imageContainer = document.getElementById('test1-image-container');
      const promptInput = document.getElementById('test1-prompt');
      const topic = promptInput.value.trim();

      if (!referenceImageBase64) {
        alert('Please upload a reference image first!');
        return;
      }

      if (!topic) {
        alert('Please enter a topic/prompt!');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = 'Generating... <div class="loading"></div>';
      output.style.display = 'block';
      output.innerHTML = '<div class="info">üé® Generating visual slide WITH reference image...</div>\n';
      output.innerHTML += `<div class="info">üìù Topic: "${topic}"</div>\n\n`;

      const startTime = Date.now();

      try {
        const result = await generateOnePager(
          {
            topic: topic,
            format: 'visual-slide',
            targetAudience: 'Professional audience',
            stylePreference: 'Modern and professional',
            referenceImage: referenceImageBase64
          },
          (progress) => {
            output.innerHTML += `<div class="info">   ‚è≥ ${progress}</div>\n`;
            output.scrollTop = output.scrollHeight;
          }
        );

        const generationTime = ((Date.now() - startTime) / 1000).toFixed(2);
        test1Result = { ...result, generationTime };

        output.innerHTML += '\n<div class="success">‚úÖ Generation Complete!</div>\n\n';
        output.innerHTML += `<div class="info">‚è±Ô∏è  Generation Time: ${generationTime}s</div>\n`;
        output.innerHTML += `<div class="info">üìã Format: ${result.format}</div>\n`;
        output.innerHTML += `<div class="info">üîó Grounding Sources: ${result.metadata.sources?.length || 0}</div>\n`;

        if (result.metadata.visualTheme) {
          output.innerHTML += '\n<div class="info">üé® Visual Theme:</div>\n';
          output.innerHTML += `   Primary: ${result.metadata.visualTheme.primaryColor}\n`;
          output.innerHTML += `   Style: ${result.metadata.visualTheme.visualStyle}\n`;
        }

        if (result.imageUrl) {
          imageContainer.innerHTML = `
            <div class="image-card">
              <h4>Generated Visual Slide (WITH Reference)</h4>
              <img src="${result.imageUrl}" class="image-preview" alt="Test 1 Result">
            </div>
          `;
          document.getElementById('download-test1').disabled = false;
        }

        updateMetrics();

      } catch (error) {
        output.innerHTML += `\n<span class="error">‚ùå ERROR: ${error.message}</span>\n`;
        console.error('Test 1 error:', error);
      }

      btn.disabled = false;
      btn.innerHTML = 'Generate Visual Slide WITH Reference';
    };

    // Test 2: Visual Slide WITHOUT Reference
    window.runTest2 = async () => {
      const output = document.getElementById('test2-output');
      const imageContainer = document.getElementById('test2-image-container');
      const promptInput = document.getElementById('test2-prompt');
      const topic = promptInput.value.trim();

      if (!topic) {
        alert('Please enter a topic/prompt!');
        return;
      }

      output.style.display = 'block';
      output.innerHTML = '<div class="info">üìù Generating visual slide WITHOUT reference image...</div>\n';
      output.innerHTML += `<div class="info">üìù Topic: "${topic}"</div>\n\n`;

      const startTime = Date.now();

      try {
        const result = await generateOnePager(
          {
            topic: topic,
            format: 'visual-slide',
            targetAudience: 'Professional audience',
            stylePreference: 'Modern and professional'
            // No referenceImage
          },
          (progress) => {
            output.innerHTML += `<div class="info">   ‚è≥ ${progress}</div>\n`;
            output.scrollTop = output.scrollHeight;
          }
        );

        const generationTime = ((Date.now() - startTime) / 1000).toFixed(2);
        test2Result = { ...result, generationTime };

        output.innerHTML += '\n<div class="success">‚úÖ Generation Complete!</div>\n\n';
        output.innerHTML += `<div class="info">‚è±Ô∏è  Generation Time: ${generationTime}s</div>\n`;
        output.innerHTML += `<div class="info">üìã Format: ${result.format}</div>\n`;
        output.innerHTML += `<div class="info">üîó Grounding Sources: ${result.metadata.sources?.length || 0}</div>\n`;

        if (result.imageUrl) {
          imageContainer.innerHTML = `
            <div class="image-card">
              <h4>Generated Visual Slide (WITHOUT Reference)</h4>
              <img src="${result.imageUrl}" class="image-preview" alt="Test 2 Result">
            </div>
          `;
          document.getElementById('download-test2').disabled = false;
        }

        updateMetrics();

      } catch (error) {
        output.innerHTML += `\n<span class="error">‚ùå ERROR: ${error.message}</span>\n`;
        console.error('Test 2 error:', error);
      }
    };

    // Test 3: LinkedIn Carousel
    window.runTest3 = async () => {
      const btn = document.getElementById('test3-btn');
      const output = document.getElementById('test3-output');
      const imageContainer = document.getElementById('test3-image-container');
      const promptInput = document.getElementById('test3-prompt');
      const topic = promptInput.value.trim();

      if (!referenceImageBase64) {
        alert('Please upload a reference image first!');
        return;
      }

      if (!topic) {
        alert('Please enter a topic/prompt!');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = 'Generating... <div class="loading"></div>';
      output.style.display = 'block';
      output.innerHTML = '<div class="info">üì± Generating LinkedIn carousel WITH reference...</div>\n';
      output.innerHTML += `<div class="info">üìù Topic: "${topic}"</div>\n\n`;

      const startTime = Date.now();

      try {
        const result = await generateOnePager(
          {
            topic: topic,
            format: 'linkedin-carousel',
            targetAudience: 'Professional audience',
            pageCount: 5,
            stylePreference: 'Vibrant and engaging',
            referenceImage: referenceImageBase64
          },
          (progress) => {
            output.innerHTML += `<div class="info">   ‚è≥ ${progress}</div>\n`;
            output.scrollTop = output.scrollHeight;
          }
        );

        const generationTime = ((Date.now() - startTime) / 1000).toFixed(2);
        test3Result = { ...result, generationTime };

        output.innerHTML += '\n<div class="success">‚úÖ Generation Complete!</div>\n\n';
        output.innerHTML += `<div class="info">‚è±Ô∏è  Generation Time: ${generationTime}s</div>\n`;
        output.innerHTML += `<div class="info">üì∏ Slides Generated: ${result.images?.length || 0}</div>\n`;

        if (result.images && result.images.length > 0) {
          imageContainer.innerHTML = result.images.map((img, idx) => `
            <div class="image-card">
              <h4>Slide ${idx + 1}</h4>
              <img src="${img}" class="image-preview" alt="Carousel Slide ${idx + 1}">
            </div>
          `).join('');
        }

        updateMetrics();

      } catch (error) {
        output.innerHTML += `\n<span class="error">‚ùå ERROR: ${error.message}</span>\n`;
        console.error('Test 3 error:', error);
      }

      btn.disabled = false;
      btn.innerHTML = 'Generate Carousel WITH Reference';
    };

    // Show side-by-side comparison
    window.showComparison = () => {
      const container = document.getElementById('comparison-container');

      if (!test1Result || !test2Result) {
        alert('Please run Test 1 and Test 2 first!');
        return;
      }

      container.style.display = 'grid';
      container.innerHTML = `
        <div class="image-card">
          <h4>WITH Reference Image</h4>
          <img src="${test1Result.imageUrl}" class="image-preview" alt="With Reference">
          <p style="font-size: 12px; margin-top: 10px;">
            Generation Time: ${test1Result.generationTime}s<br>
            Primary Color: ${test1Result.metadata.visualTheme?.primaryColor || 'N/A'}
          </p>
        </div>
        <div class="image-card">
          <h4>WITHOUT Reference Image</h4>
          <img src="${test2Result.imageUrl}" class="image-preview" alt="Without Reference">
          <p style="font-size: 12px; margin-top: 10px;">
            Generation Time: ${test2Result.generationTime}s<br>
            Primary Color: ${test2Result.metadata.visualTheme?.primaryColor || 'N/A'}
          </p>
        </div>
      `;
    };

    // Update metrics display
    window.updateMetrics = () => {
      const container = document.getElementById('metrics-container');
      const metrics = [];

      if (test1Result) {
        metrics.push({
          test: 'Test 1: Visual Slide WITH Reference',
          time: test1Result.generationTime + 's',
          sources: test1Result.metadata.sources?.length || 0,
          theme: test1Result.metadata.visualTheme?.visualStyle || 'N/A'
        });
      }

      if (test2Result) {
        metrics.push({
          test: 'Test 2: Visual Slide WITHOUT Reference',
          time: test2Result.generationTime + 's',
          sources: test2Result.metadata.sources?.length || 0,
          theme: test2Result.metadata.visualTheme?.visualStyle || 'N/A'
        });
      }

      if (test3Result) {
        metrics.push({
          test: 'Test 3: LinkedIn Carousel WITH Reference',
          time: test3Result.generationTime + 's',
          slides: test3Result.images?.length || 0,
          sources: test3Result.metadata.sources?.length || 0
        });
      }

      if (metrics.length === 0) return;

      container.innerHTML = metrics.map(m => `
        <div class="metrics">
          <h3>${m.test}</h3>
          <div class="metric-row">
            <div class="metric-label">Generation Time:</div>
            <div>${m.time}</div>
          </div>
          ${m.sources !== undefined ? `
          <div class="metric-row">
            <div class="metric-label">Grounding Sources:</div>
            <div>${m.sources}</div>
          </div>
          ` : ''}
          ${m.theme ? `
          <div class="metric-row">
            <div class="metric-label">Visual Theme:</div>
            <div>${m.theme}</div>
          </div>
          ` : ''}
          ${m.slides !== undefined ? `
          <div class="metric-row">
            <div class="metric-label">Slides Generated:</div>
            <div>${m.slides}</div>
          </div>
          ` : ''}
        </div>
      `).join('');
    };

    // Download image
    window.downloadImage = (testId) => {
      let result;
      let filename;

      switch (testId) {
        case 'test1':
          result = test1Result;
          filename = 'visual-slide-with-reference.png';
          break;
        case 'test2':
          result = test2Result;
          filename = 'visual-slide-without-reference.png';
          break;
        default:
          return;
      }

      if (!result || !result.imageUrl) return;

      const link = document.createElement('a');
      link.href = result.imageUrl;
      link.download = filename;
      link.click();
    };

    console.log('‚úÖ Reference Image Quality Test Suite loaded!');
    console.log('üìù Instructions:');
    console.log('   1. Upload a reference image');
    console.log('   2. Run Test 1 (WITH reference)');
    console.log('   3. Run Test 2 (WITHOUT reference for comparison)');
    console.log('   4. Compare results side-by-side');
  </script>
</body>
</html>
